âŸ¨câ‡color, winâ‡window, dâ‡draw, keyâŸ©â†râ†â€¢Import "../../rayed-bqn/rayed.bqn"

block â† {
	Fall â‡ {âŸ¨gravity, fricâŸ©ğ•Š[pos, vel]: [pos + vel, (1-fric) Ã— vel + 0â€¿gravity]}
	Bounce â‡ {âŸ¨bbox, fricâŸ©ğ•Š[pos, vel]: [pos, {âˆ¨Â´0>bbox-pos}â—¶âŸ¨vel, (1-fric)Ã—velÃ—Â¯1âŸ© @]}

	Draw â‡ {ğ•Š[pos, vel]: c.black d.Rectangle pos (-â‰+) 50â€¿50}
}

_OnStart â† {System _ğ•£ ğ•©:
	c â† {
		wâ€¿h â‡ win_size 	â‡ 800â€¿800
		font 		â‡ r.font.LoadBQN 200
		gravity 	â‡ 1.5
		friction 	â‡ 0.01
	}
	win.SetSize c.win_size

	# Initialise and create all the game objects
	game_objects â† {
		player â‡ {
			âŸ¨DrawâŸ© 	â‡ block
			Get 	â‡ {ğ•Š: [(Ã·âŸœ2 c.h)â€¿0, 0â€¿1.6]}
			Apply 	â‡ {dataâ†©ğ•©}
			data	â‡ Get@
		}
		start_time â‡ {
			Get 	â‡ {ğ•Š: â€¢MonoTime@}
			Apply 	â‡ {dataâ†©ğ•©}
			data 	â‡ Get@
		}
	}

	states â† {
		play â‡ {
			Update â‡ {ğ•ŠâŸ¨playerâŸ©:{
				player â‡ âŸ¨c.win_sizeÃ—0.8, c.frictionâŸ© block.Bounce âŸ¨c.gravity, c.frictionâŸ© block.Fall player.data
			}}
			Draw â‡ {ğ•Šobjs: âŸ¨objs.playerâŸ©}
			NewState â‡ {ğ•ŠâŸ¨player, start_timeâŸ©: (3 < start_time.data -Ëœ â€¢MonoTime@)â—¶âŸ¨states.play, states.resetâŸ© @ }
		}
		reset â‡ {
			Update â‡ {ğ•ŠâŸ¨player, start_timeâŸ©: {playerâ‡player.Get@, start_timeâ‡start_time.Get@}}
			Draw 	â‡ {ğ•Š: âŸ¨âŸ©}
			NewState â‡ {ğ•Š: states.play}
		}
	}

	System âŸ¨âŸ¨{â‡}, states.playâŸ©, game_objectsâŸ©
}

Vals â† âŠ£ â€¢ns.GetÂ¨ Â· â€¢ns.Keys âŠ¢
PerFrame â† {ğ•Š âŸ¨last_state, stateâŸ©â€¿objs:

	fresh_objs â† state.Update objs
	v â† Vals fresh_objs
	v {ğ•©.Apply ğ•¨}Â¨ objs Vals fresh_objs

	{ğ•©.Draw ğ•©.data}Â¨ state.Draw objs

	last_state â†© state
	state â†© state.NewState objs

	âŸ¨last_state, stateâŸ©â€¿objs
} d._withCanvas_ c.white

System â† PerFrame â€¢_While_(Â¬win.ShouldClose) _OnStart
System win._openAs "example"
