âŸ¨câ‡color, winâ‡window, dâ‡draw, mâ‡mouse, keyâŸ©â† r â† â€¢Import "../../rayed-bqn/rayed.bqn"

Norm â† Ã·âŸœ(0âŠ¸=âŠ¸++Â´âŒ¾(Ã—Ëœ)) # Credits to Brian E

Take â† {vğ•Šm: (Size m)â†‘â‰1 (Pos m)â†“â‰1 v}
Pos â† âŠ‘/
Size â† +Â´
FromTo â† {vğ•Šmfâ€¿mt: mtâŠ¸Ã—â‰1 (â‰ mt)âŠ¸â¥Šâ‰1 v Take mf }
NormM â† Â¬âŠ¸(+â‰1)

# Particle system
ps â† {
	max_life â† 5
	m â† {
		pâ€¿vâ€¿fâ€¿lâ€¿s â† options â† â†•5
		comp â† pâ€¿pâ€¿vâ€¿vâ€¿fâ€¿lâ€¿s
		[pos, vel, fric, life, size] â‡ options =âŒœ comp
	}

	Get â‡ {ğ•Šamountâ€¿spawn_point: >{ğ•Š:
		pos â† spawn_point + â€¢rand.RangeÂ¨ + 20â€¿20
		vel â† (10-â€¢rand.RangeÂ¨ 20â€¿20) Ã· 10
		fric â† 1 - 0.0001 Ã— â€¢rand.Range 200
		life â† (â€¢rand.Range max_lifeÃ—100)Ã·100
		size â† 4 + 0.1 Ã— â€¢rand.Range 30
		posâˆ¾velâˆ¾fricâˆ¾lifeâˆ¾size
	}Â¨ â†•amount}

	# Attract â‡ {attractorsğ•Šp: [pos + vel, (1-fric) Ã— vel + 0â€¿gravity]}
	Die 	â‡ {ğ•Šp: (m.life Ã— 0.1)âŠ¸-Ë˜ p }
	Spawn 	â‡ {âŸ¨spâŸ©ğ•Šp: p (0âŠ¸â‰¥Â·âŠ‘âŠ¢)â—¶âŸ¨âŠ£, âŠGet 1â€¿spâŸ©Ë˜ p Take m.life }
	Move 	â‡ {ğ•Šp: p + p FromTo m.velâ€¿m.pos}
	Fric 	â‡ {ğ•Šp: p Ã— m.vel NormM p FromTo m.fricâ€¿m.vel }
	Attract â‡ {attrsğ•Šp:
		{ğ•Šattr:
			to_attr â† NormË˜ (âŠattr) - â‰1 p Take m.pos
			p + âŸ¨1â€¿1, m.velâŸ© FromToËœ Ã—âŸœ0.4 to_attr
		}Ë˜ attrs
	}

	Draw â‡ {ğ•Šp:
		poss â† p Take m.pos
		sizes â† âˆ¾ËœË˜ p Take m.size
		shapes â† poss (âŠ£â‰+)Ë˜ sizes

		life â† p Take m.life
		colors â† 255 âˆ¾ËœË˜ 255âŠ¸-Ë˜ âŒŠ|255 Ã— 3â¥ŠË˜ Ã·Ë˜âŸœmax_life life

		colors d.RectangleË˜ âŒŠshapes
	}
}

attrs â† {
	NewPos â‡ {ğ•Š:@}

	Draw â‡ {ğ•Š:@}
}

_OnStart â† {System _ğ•£ ğ•©:
	c â† {
		wâ€¿h â‡ win_size 	â‡ 800â€¿800
		gravity 	â‡ 1.5
		friction 	â‡ 0.01
	}
	win.SetSize c.win_size

	# Initialise and create all the game objects
	game_objects â† {
		system â‡ {
			Get 	â‡ {ğ•Š: ps.Get 200â€¿(c.win_sizeÃ·2)}
			Draw	â‡ ps.Draw
			Apply 	â‡ {dataâ†©ğ•©}
			data 	â‡ Get@
		}
		attractors â‡ {
			Get 	â‡ {ğ•Š: >{â‰Ëœ â€¢rand.RangeÂ¨ c.wâ€¿c.h-ğ•©}Â¨ â†•5}
			Draw 	â‡ attrs.Draw
			Apply 	â‡ {dataâ†©ğ•©}
			data 	â‡ Get@
		}
	}

	states â† {
		play â‡ {
			Update â‡ {ğ•ŠâŸ¨system, attractorsâŸ©:{â‡
				system â‡ (âŠË˜ attractors.data) ps.Attract ps.Fric ps.Move system.data
			}}
			Draw â‡ {ğ•Šobjs: âŸ¨objs.system, objs.attractorsâŸ©}
			NewState â‡ {ğ•Š: states.play }
		}
	}

	System âŸ¨âŸ¨{â‡}, states.playâŸ©, game_objectsâŸ©
}

Vals â† âŠ£ â€¢ns.GetÂ¨ Â· â€¢ns.Keys âŠ¢
PerFrame â† {ğ•Š âŸ¨last_state, stateâŸ©â€¿objs:

	fresh_objs â† state.Update objs
	v â† Vals fresh_objs
	v {ğ•©.Apply ğ•¨}Â¨ objs Vals fresh_objs

	{ğ•©.Draw ğ•©.data}Â¨ state.Draw objs

	last_state â†© state
	state â†© state.NewState objs

	âŸ¨last_state, stateâŸ©â€¿objs
} d._withCanvas_ c.white

System â† PerFrame â€¢_While_(Â¬win.ShouldClose) _OnStart
System win._openAs "example"
