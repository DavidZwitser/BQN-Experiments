âŸ¨câ‡color, winâ‡window, dâ‡draw, mâ‡mouse, key, raymath, rayffiâŸ©â†râ†â€¢Import "../../raylib.bqn"

Dist â† +Â´âŒ¾(Ã—Ëœ)- 		# Credits to Brian E
Norm â† Ã·âŸœ(0âŠ¸=âŠ¸++Â´âŒ¾(Ã—Ëœ)) # Credits to Brian E
frame â† time â† dt â† deltatime â† 1
center â† wâ€¿h â† size â† 0â€¿0

Lfo â† {ğ•Š stepâ€¿size:
	size Ã— â€¢math.Sin time Ã— step Ã— Ï€Ã·2
}
RRâ†â€¢rand.Range
Rand â† {
	ğ•Šrange: (â‰ range)â‰¡1 ? 				RRÂ¨ â‰ âŠ¸â¥Šrange;
	ğ•Šrangeâ€¿offset: 	offset +   		RRÂ¨ â‰ âŠ¸â¥Šrange;
	ğ•Šrangeâ€¿offsetâ€¿res: offset + Ã·âŸœres 	RRÂ¨ â‰ âŠ¸â¥Š(range Ã— res)
}

# particle system
PS â† {ğ•Š amount:
	m â† masks â† {
		pâ€¿vâ€¿fâ€¿lâ€¿s â‡ options â† â†•5
		comp â† pâ€¿pâ€¿vâ€¿vâ€¿fâ€¿lâ€¿s
		[pos, vel, fric, life, size] â‡ options =âŒœ comp
	}

	# fill masked - mâ†mask, vâ†value(s)
	FM â† {mğ•Šv: mÃ—â‰1 (-Â·âŠ‘â’m)âŠ¸âŒ½ (â‰ m)â¥Šâ‰1 v}
	# get values - mâ†mask, lâ†particle list or table
	GV â† {mğ•Šl: >â¥Š1â†‘â‰1 (Â¬m)âŠ¸âŠ”â‰1 l}

	# transport values from one position to another
	# fromâ†from_mask, toâ†to_mask, Fâ†{to-masked_to_valsğ•Što-masked_from_vals}, tâ†particles_table
	_FromTo â† {fromâ€¿to F _ğ•£ t:
		base â† (Â¬to)âŠ¸Ã—Ë˜ t
		orig â† toâŠ¸Ã—Ë˜ t

		{(+Â´from) â‰¡ (+Â´to) ?
			base + orig F (to -â—‹(âŠ‘â‹) from)âŒ½Ë˜ fromâŠ¸Ã—Ë˜ t
		;
			base + orig F to FM from GV t
		}
	}

	max_life 	â† 500
	NewParticle â† {ğ•Š:
		FMR â† FMâŸœRand
		+Â´ âŸ¨masks.pos   FMR (200â€¿200)â€¿spawn_point
			masks.vel   FMR {(ğ•©â€¿ğ•©)â€¿(Ã·âŸœ2-ğ•©)â€¿100}2
			masks.fric  FMR {ğ•©â€¿(1-ğ•©)â€¿10000}0.01
			masks.life  FMR max_lifeâ€¿0â€¿100
			masks.size  FMR 15â€¿3
		âŸ©
	}

	spawn_point â† center
	Update â‡ {ğ•Š attractors:
		# Oscillate spawnpoint
		spawn_point â†© center + âŒŠ LFOÂ¨ 0.2â€¿0.3 âˆ¾Â¨ Ã·âŸœ2 center

		# Respawn on dead
		particles {(0< +Â´ m.life Ã— ğ•©) â‰¢ 0 ? ğ•© ; NewParticle @ }Ë˜ â†©

		# Updating lifetime
		particles -âŸœ(m.life Ã— deltatime)Ë˜ â†©

		# Handling attraction
		Attr â† {velsğ•Špos: pos GVËœâ†© m.vel
			vels - m.velâŠ¸FMË˜ +Ë {ğ•Šattr:

				to_attr â† -âŸœattrË˜ pos
				strength â† 800000 Ã· â‹†âŸœ2 pos DistË˜ to_attr

				(NormË˜ to_attr) Ã—Ë˜ strength
			}Ë˜ attractors
		}
		particles { m.posâ€¿m.vel Attr _FromTo ğ•©} â†©

		# Updating their velocities
		particles {m.fricâ€¿m.vel (dtÃ—Ã—) _FromTo ğ•©} â†©

		# Updating their positions
		particles {m.velâ€¿m.pos  (dtÃ—+) _FromTo ğ•©} â†©
	}

	Resize â‡ {ğ•Š:@}
	Show â‡ {ğ•Š: â€¢Show particles}

	Render â‡ {ğ•Š:
		colors â† 4â¥ŠË˜ |âŒŠ 255Ã— Ã·âŸœmax_life m.life GV particles
		poss   â† m.pos GV particles
		sizes  â† m.size GV particles

		colors d.RectangleË˜ âŒŠposs (-â‰+)Ë˜ 2â¥ŠË˜ sizesÃ·2
	}

	particles â† NewParticleË˜ amountâ¥Š1
}

# Attractors
Attrs â† {ğ•Šamount:
	move_area â† 2000
	Poss â† {ğ•Šamount: {(center+move_areaÃ·4) - âŒŠ â€¢rand.RangeÂ¨ Ã·âŸœ2 move_area Ã— 1â€¿1 Ã— âŠ‘ğ•©}Ë˜ amountâ¥Š1 }

	attractors â‡ target_poss â‡ Poss amount
	Mouse â‡ {ğ•Špos: attractors (âŒŠPosË˜)â†© }
	ChangeTargets â‡ {ğ•Š: target_poss (Possâ‰ )â†©}
	Resize â‡ {ğ•Š: ChangeTargets @ }
	Update â‡ {ğ•Š: attractors +â†© dtÃ— 0.05Ã— target_poss-attractors }

	size â† 20
	Render â‡ {ğ•Š: {c.white d.Ellipse âŒŠ (ğ•© (- â‰ +) 2â¥ŠsizeÃ·2)}Ë˜ attractors}
}

Resize â† {ğ•Š particlesâ€¿attractors:
	wâ€¿h â†© size â†© win.GetSize@, center â†© sizeÃ·2
	particles.Resize @
	attractors.Resize @
}
Run â† {ğ•Š particlesâ€¿attractors:
	# attractors.Mouse +âŸœ1 m.GetPos @
	particles.Update attractors.attractors
	attractors.Update @
	particles.Render @
	attractors.Render @
}

_OnStart â† {System _ğ•£ ğ•©:
	particles â† Ps 1000
	attractors â† Attrs 2
	Resize particlesâ€¿attractors

	System particlesâ€¿attractors
}

PerFrame â† {ğ•Šparticlesâ€¿attractors : model â† particlesâ€¿attractors
	frame +â†© 1, time +â†© dt â† deltatime â† rayffi.GetFrameTime @
	{ rayffi.IsWindowResized @ ? Resize model ; @}
	{ key.IsPressed key.e ? attractors.ChangeTargets @ ; @}

	Run model

	rayffi.DrawFPS 10â€¿10
	model
} d._withCanvas_ c.black

r.rayffi.SetTraceLogLevel r.traceLogLevel.warning
System â† PerFrame â€¢_While_(Â¬win.ShouldClose) _OnStart
System win._openAs "test"
