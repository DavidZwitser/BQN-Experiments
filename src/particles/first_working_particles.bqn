âŸ¨câ‡color,winâ‡window,dâ‡draw,mâ‡mouseâŸ©â†râ†â€¢Import "../../rayed-bqn/rayed.bqn"
rayffiâ†â€¢Import "../../rayed-bqn/ffi/raylib.bqn"

Dist â† +Â´âŒ¾(Ã—Ëœ)-
frame â† time â† 1
deltatime â† 1
center â† wâ€¿h â† size â† 0â€¿0
Lfo â† {ğ•Š stepâ€¿size:
	Ã—âŸœsize â€¢math.Sin Ã—âŸœtime Ã—âŸœstep Ï€Ã·2
}
Rand â† {
	ğ•Šrange: (â‰ range)â‰¡1 ?
		â€¢rand.Range range;

	ğ•Šrangeâ€¿count:
		â€¢rand.RangeÂ¨ countâ¥Šrange;

	ğ•Šrangeâ€¿countâ€¿offset:
		+âŸœoffset â€¢rand.RangeÂ¨ countâ¥Šrange;

	ğ•Šrangeâ€¿countâ€¿offsetâ€¿res:
		+âŸœoffset Ã·âŸœres â€¢rand.RangeÂ¨ countâ¥Š(range Ã— res)
}

colors â† âŸ¨
 	c.moccasin, c.darkred, c.orange, c.aqua
âŸ©

# particle system
Ps â† {ğ•Š amount:
	masks â† composition â† {
		all â‡ pâ€¿vâ€¿fâ€¿lâ€¿sâ€¿c â‡ â†•6
		comp â‡ pâ€¿pâ€¿vâ€¿vâ€¿fâ€¿lâ€¿sâ€¿câ€¿câ€¿câ€¿c
		Match â† comp=âŠ¢

		pos   â‡ p Matchâ†©
		vel   â‡ v Matchâ†©
		fric  â‡ f Matchâ†©
		life  â‡ l Matchâ†©
		size  â‡ s Matchâ†©
		color â‡ c Matchâ†©
		full  â‡ 1Â¨comp
	}

	# fill masked
	FM â† {mğ•Šv: Ã—âŸœm (âŠ‘â’m)âŠ¸âŒ½ (â‰ m)â¥Šv}
	# get masked
	GM â† {mğ•Šl: lÃ—m}
	# get specific value
	GV â† {mğ•Šl: âŠ‘(Â¬m)âŠ”l}
	# transport values from one part to another (size polymorphically)
	FromTo â† {fromâ€¿toğ•Šl: to FM (from GV l)}
	Rotate â† { fromâ€¿toğ•Šl:
		(from -â—‹(âŠ‘â’) to) âŒ½ l
	}

	# masks.posâ€¿masks.size FromTo 4â€¿324â€¿34â€¿4â€¿7653â€¿756â€¿3â€¿75â€¿23â€¿54â€¿99

	spawn_point â† center
	max_life 	â† 400

	NewParticle â† {ğ•Š:
		FMR â† FMâŸœRand
		+Â´ âŸ¨masks.pos   FMR (20â€¿20)â€¿2â€¿spawn_point
			masks.vel   FMR {ğ•©â€¿2â€¿(Ã·âŸœ2-ğ•©)}15
			masks.fric  FMR 0.02â€¿1â€¿0.98â€¿10000
			masks.life  FMR max_lifeâ€¿1â€¿0â€¿100
			masks.size  FMR 4
			masks.color FM ((Randâ‰ ) âŠ‘ âŠ¢) colorsâŸ©
	}

	Update â‡ {ğ•Š:
		# LFO spawnpoint
		spawn_point â†© center + (âŒŠLfo 0.1â€¿(wÃ·2))â€¿(âŒŠLfo 0.3â€¿(hÃ·2))

		# Respawn on dead
		particles {(0< +Â´ masks.life GM ğ•©) â‰¢ 0 ? ğ•© ; NewParticle @ }Ë˜ â†©

		# Fade out
		particles {((Â¬masks.color)âŠ¸Ã—Ë˜ğ•©) + âŒŠ Ã—âŸœ255 Ã·âŸœmax_life masks.lifeâ€¿masks.colorâŠ¸FromToË˜ ğ•©} â†©

		# Updating lifetime
		particles {((Â¬masks.life)âŠ¸Ã—Ë˜ğ•©) + masks.lifeâŠ¸GMË˜ -âŸœdeltatime ğ•©} â†©

		# Updating their velocities
		particles {((Â¬masks.vel)âŠ¸Ã—Ë˜ğ•©) + ğ•©Ã— masks.fricâ€¿masks.velâŠ¸FromToË˜ ğ•©} â†©

		# Updating their positions
		particles {ğ•©âŠ¸+ masks.velâ€¿masks.posâŠ¸ FromToË˜ ğ•©} â†©
	}

	Render â‡ {ğ•Š:
		{ ğ•Šparticle:
			color â† masks.color GV particle
			pos   â† masks.pos   GV particle
			size  â† masks.size 	GV particle

			color d.Rectangle âŒŠ (pos (- â‰ +) 4â€¿4Ã·2)
		}Ë˜ particles
	}

	Show â‡ {ğ•Š: â€¢Show particles }

	particles â† NewParticleË˜ amountâ¥Š1
	attractor â† (wÃ·2)â€¿(hÃ·2)
}

_OnStart â† {Game _ğ•£ ğ•©:
  	font â† r.font.LoadBQN 100
	Resize @

	particle_system â† Ps 5000

	Game fontâ€¿particle_system
}

Resize â† {ğ•Š: wâ€¿h â†© size â†© win.GetSize@, center â†© sizeÃ·2 }


PerFrame â† {ğ•Šfontâ€¿particle_system :
	frame +â†© 1, time +â†© deltatime â† rayffi.GetFrameTime âŸ¨âŸ©
	(âŠ¢ â—¶ @â€¿Resize) rayffi.IsWindowResized âŸ¨âŸ©

	particle_system.Update @
	particle_system.Render @

	rayffi.DrawFPS 10â€¿10

	fontâ€¿particle_system
} d._withCanvas_ c.black

Game â† PerFrame â€¢_While_(Â¬win.ShouldClose) _OnStart
Game win._openAs "test"
