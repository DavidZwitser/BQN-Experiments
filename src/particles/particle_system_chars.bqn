
âŸ¨câ‡color, winâ‡window, dâ‡draw, mâ‡mouse, key, raymathâŸ©â†râ†â€¢Import "../../rayed-bqn/rayed.bqn"
rayffiâ†â€¢Import "../../rayed-bqn/ffi/raylib.bqn"

Dist â† +Â´âŒ¾(Ã—Ëœ)- 		# Credits to Brian E
Norm â† Ã·âŸœ(0âŠ¸=âŠ¸++Â´âŒ¾(Ã—Ëœ)) # Credits to Brian E
frame â† time â† dt â† deltatime â† 1
center â† wâ€¿h â† size â† 0â€¿0


Lfo â† {ğ•Š stepâ€¿size:
	Ã—âŸœsize â€¢math.Sin Ã—âŸœtime Ã—âŸœstep Ï€Ã·2
}
RRâ†â€¢rand.Range
Rand â† {
	ğ•Šrange: (â‰ range)â‰¡1 ? 				RRÂ¨ â‰ âŠ¸â¥Šrange;
	ğ•Šrangeâ€¿offset: 	+âŸœoffset   		RRÂ¨ â‰ âŠ¸â¥Šrange;
	ğ•Šrangeâ€¿offsetâ€¿res: +âŸœoffset Ã·âŸœres 	RRÂ¨ â‰ âŠ¸â¥Š(range Ã— res)
}

# particle system
PS â† {ğ•Š amount:
	m â† masks â† {
		pâ€¿vâ€¿fâ€¿lâ€¿sâ€¿c â‡ options â† â†•6
		comp â† pâ€¿pâ€¿vâ€¿vâ€¿fâ€¿lâ€¿sâ€¿c
		[pos, vel, fric, life, size, char] â‡ options =âŒœ comp
	}

	# fill masked - mâ†mask, vâ†value(s)
	FM â† {mğ•Šv: Ã—âŸœmâ‰1 (-Â·âŠ‘â’m)âŠ¸âŒ½ (â‰ m)â¥Šâ‰1 v}
	# get values - mâ†mask, lâ†particle list or table
	GV â† {mğ•Šl: >â¥Š1â†‘â‰1 (Â¬m)âŠ¸âŠ”â‰1 l}

	# transport values from one position to another
	# fromâ†from_mask, toâ†to_mask, Fâ†{to-masked_to_valsğ•Što-masked_from_vals}, tâ†particles_table
	_FromTo â† {fromâ€¿to F _ğ•£ t:
		base â† (Â¬to)âŠ¸Ã—Ë˜ t
		orig â† toâŠ¸Ã—Ë˜ t

		{(+Â´from) â‰¡ (+Â´to) ?
			base + origâŠ¸F (to -â—‹(âŠ‘â‹) from)âŒ½Ë˜ fromâŠ¸Ã—Ë˜ t
		;
			base + origâŠ¸F to FM from GV t
		}
	}

	max_life 	â† 500
	chars  		â† "+-Ã—Ã·â‹†âˆšâŒŠâŒˆâˆ§âˆ¨Â¬|â‰¤<â‰¥>=â‰ â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â‹ˆâ†‘â†“â†•Â«Â»âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”!ğ”½ğ”¾ğ•Šğ•—ğ•˜ğ•¤Ë™ËœË˜Â¨âŒœâ¼`âˆ˜â—‹âŠ¸âŸœâŒ¾âŠ˜â—¶âŠâ‰âš‡âŸâ†â‡â†©.;:?â€¢ğ•£ğ•¨ğ•©ğ•ğ•â‹„,{}âŸ¨âŸ©()[]â€¿Â·Â¯Ï€âˆ@#â€‹"
	indexes 	â† âŸ¨51,                                               7,     11,        13,          10,        5,  1,1âŸ©
	char_colors â† âŸ¨57â€¿165â€¿72, 148â€¿65â€¿139, 153â€¿136â€¿24, 204â€¿205â€¿203, 156â€¿125â€¿193, 167â€¿50â€¿39, 63â€¿153â€¿171, 63â€¿61â€¿170âŸ©
	# Very wastefull I know
	indexed_colors â† indexes/char_colors

	NewParticle â† {ğ•Š:
		FMR â† FMâŸœRand
		+Â´ âŸ¨masks.pos   FMR (200â€¿200)â€¿spawn_point
			masks.vel   FMR {(ğ•©â€¿ğ•©)â€¿(Ã·âŸœ2-ğ•©)â€¿100}2
			masks.fric  FMR {ğ•©â€¿(1-ğ•©)â€¿10000}0.01
			masks.life  FMR max_lifeâ€¿0â€¿1000
			masks.size  FMR 15â€¿3
			masks.size  FMR 15â€¿3
			masks.char  FMR âŒŠ â‰ chars
		âŸ©
	}

	spawn_point â† center
	Update â‡ {ğ•Š attractors:
		# Oscillate spawnpoint
		spawn_point â†© center + âŒŠ LFOÂ¨ 0.2â€¿0.3 âˆ¾Â¨ Ã·âŸœ2 center

		# Respawn on dead
		particles {(0< +Â´ m.life Ã— ğ•©) â‰¢ 0 ? ğ•© ; NewParticle âŸ¨âŸ© }Ë˜ â†©

		# Updating lifetime
		particles -âŸœ(m.life Ã— deltatime)Ë˜ â†©

		# Handling attraction
		Attr â† {velsğ•Špos: pos (m.velâŠ¸GV) â†©
			vels - m.velâŠ¸FMË˜ +Ë {ğ•Šattr:

				to_attr â† -âŸœattrË˜ pos
				strength â† 800000 Ã· â‹†âŸœ2 pos DistË˜ to_attr

				(NormË˜ to_attr) Ã—Ë˜ strength
			}Ë˜ attractors
		}
		particles { m.posâ€¿m.vel Attr _FromTo ğ•©} â†©

		# Updating their velocities
		particles {m.fricâ€¿m.vel Ã—âŸœdtâˆ˜Ã— _FromTo ğ•©} â†©

		# Updating their positions
		particles {m.velâ€¿m.pos  Ã—âŸœdtâˆ˜+ _FromTo ğ•©} â†©
	}

	Resize â‡ {ğ•Š:âŸ¨âŸ©}
	Show â‡ {ğ•Š: â€¢Show particles}

	Render â‡ {ğ•Šfont:

		texts  â† âŠ‘âŸœcharsË˜ m.char GV particles
		colors â† âŠ‘âŸœindexed_colorsË˜ m.char GV particles
		# Add the alpha row based on life
		colors {ğ•© âˆ¾Ë˜âŒŠ| Ã—âŸœ255 Ã·âŸœmax_life m.life GV particles}â†©

		poss   â† m.pos GV particles
		sizes  â† 3Ã— m.size GV particles
		fonts  â† (â‰¢sizes)â¥Šâ‹ˆfont

		Fishie â† â‰Â·><Ë˜Â¨
		args â† Fishie âŸ¨colors, fonts, sizes,  poss, textsâŸ©

		# Some rather peculilar deconstructing needs to be done. It's to fishy for me to understand
		{ğ•Šcâ€¿fâ€¿sâ€¿pâ€¿t: fâ€¿s â†©âŠ‘Â¨ fâ€¿s, câ€¿fâ€¿s d.Text pâ€¿t}Ë˜ args
	}

	particles â† NewParticleË˜ amountâ¥Š1
}

# Attractors
Attrs â† {ğ•Šamount:
	move_area â† 3000
	Poss â† {ğ•Šamount: {(center+move_areaÃ·4) - âŒŠ â€¢rand.RangeÂ¨ Ã·âŸœ2 move_area Ã— 1â€¿1 Ã— âŠ‘ğ•©}Ë˜ amountâ¥Š1 }

	attractors â‡ target_poss â‡ Poss amount
	Mouse â‡ {ğ•Špos: attractors (âŒŠPosË˜)â†© }
	ChangeTargets â‡ {ğ•Š: target_poss (Possâ‰ )â†©}
	Resize â‡ {ğ•Š: ChangeTargets âŸ¨âŸ© }
	Update â‡ {ğ•Š: attractors +â†© Ã—âŸœdt Ã—âŸœ0.05 target_poss-attractors }

	size â† 20
	Render â‡ {ğ•Š: {c.beige d.Ellipse âŒŠ (ğ•© (- â‰ +) 2â¥ŠsizeÃ·2)}Ë˜ attractors}
}

Resize â† {ğ•Š fontâ€¿particlesâ€¿attractors:
	wâ€¿h â†© size â†© win.GetSizeâŸ¨âŸ©, center â†© sizeÃ·2
	particles.Resize âŸ¨âŸ©
	attractors.Resize âŸ¨âŸ©
}
Run â† {ğ•Š fontâ€¿particlesâ€¿attractors:
	# attractors.Mouse +âŸœ1 m.GetPos âŸ¨âŸ©
	attractors.Update âŸ¨âŸ©
	particles.Update attractors.attractors
	attractors.Render âŸ¨âŸ©
	particles.Render font
}

_OnStart â† {System _ğ•£ ğ•©:
	particles â† Ps 500
	attractors â† Attrs 2
	font â† r.font.LoadBQN 50

	Resize fontâ€¿particlesâ€¿attractors

	System fontâ€¿particlesâ€¿attractors
}

PerFrame â† {ğ•Šfontâ€¿particlesâ€¿attractors : model â† fontâ€¿particlesâ€¿attractors
	frame +â†© 1, time +â†© dt â† deltatime â† rayffi.GetFrameTime âŸ¨âŸ©
	{ rayffi.IsWindowResized âŸ¨âŸ© ? Resize model ; @}
	{ key.IsPressed key.space ? attractors.ChangeTargets âŸ¨âŸ© ; @}

	Run model

	# rayffi.DrawFPS 10â€¿10
	model
} d._withCanvas_ c.white

# r.rayffi.SetTraceLogLevel r.traceLogLevel.warning
System â† PerFrame â€¢_While_(Â¬win.ShouldClose) _OnStart
System win._openAs "test"
