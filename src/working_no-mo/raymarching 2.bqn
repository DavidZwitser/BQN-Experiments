âŸ¨câ‡color,winâ‡window,dâ‡draw,mâ‡mouse, raymathâŸ©â†râ† â€¢Import "../../rayed-bqn/rayed.bqn"
rayffi â† â€¢Import "../../rayed-bqn/raylib.bqn"

# Dist â† âˆš+Â´Â·â‹†âŸœ2-
# Dist â† {âˆš+Â´(ğ•¨-ğ•©)â‹†2}
Dist â† +Â´âŒ¾(Ã—Ëœ)-
L â† +Â´âŒ¾(Ã—Ëœ)
time â† 0

colors â† âŸ¨
 c.moccasin, c.lightred, c.orange
âŸ©

size â† wâ€¿h â† 0â€¿0
scale â† 20
field â† 0
_OnStart â† {ğ•¨ Func _ğ•£ ğ•©:
  	font â† r.font.LoadBQN 100

	wâ€¿h â†© size â†© âŒŠ(win.GetSize @) Ã· scale
	field â†© > {âŸ¨âŒŠw|ğ•©, âŒŠğ•©Ã·wâŸ©} wâ€¿hâ¥Šâ†•wÃ—h

	img â† (sizeâˆ¾4) â¥Š255

	{ğ•Štex:
		texâ€¿font Func imgâ€¿Â¯2
	} r.texture._WithImage img
}

Lfo â† {ğ•Š stepâ€¿size: (((â€¢math.Sin ((10Ã·âŒŠ10Ã—time Ã— Ï€Ã·2) Ã— step)) Ã— size) + 1) Ã· 2}
Sphere â† {pğ•Šr: -âŸœr L p }
Box â† {pğ•Šs:
	q â† -âŸœs | p
	+âŸœ(L(qâŒˆ0.0)) âŒŠâŸœ0.0 âŒˆÂ´q
}
SDF â† {pğ•Šr:
	b â† (p+(1â€¿0â€¿1)) Box 1â€¿1â€¿1
	s â† p Sphere r
	s
}

hit_threshold â† 0.05
max_distance â† 100

March â† {posğ•Šdir:
	total_distance â† 0
	hit â† 0
	{ğ•Š:
		curr_pos â† pos + dir Ã— total_distance
		dist â† curr_pos SDF 1

		{ dist < hit_threshold ?
			hit â†© 1
			dist
		; total_distance > max_distance ?
			0
		;
			total_distance +â†© dist
			1
		}

	}â€¢_While_{ğ•© â‰¡ 1} 1

	# hit

}

last â† 0â€¿0
sensitivity â† 1
camera_pos â† 0â€¿0â€¿Â¯4

PerFrame â† {texâ€¿fontğ•Šimgâ€¿wheel:
	xâ€¿y â† mouse â† m.GetPos @
	mxâ€¿my â† -âŸœ1 Ã—âŸœ2 Ã·âŸœ(sizeÃ—scale) m.GetPos @
	time +â†© rayffi.GetFrameTime @
	wheel +â†© Ã—âŸœ0.1 m.WheelMoved @

	dxâ€¿dy â† mouse - last
	last â†© mouse
	md â† rayffi.IsMouseButtonDown m.button.left

	RotateX â† {ğ•© raymath.MPËœ raymath.MatrixRotateY mdâˆ§(dxÃ·w)Ã—sensitivity }
	RotateY â† {ğ•© raymath.MPËœ raymath.MatrixRotateX mdâˆ§((-dy)Ã·h)Ã—sensitivity }
	camera_pos â†© RotateY RotateX camera_pos

	Mask_func â† {
		uâ€¿v â† -âŸœ1 Ã—âŸœ2 Ã·âŸœsize ğ•¨â€¿ğ•©
		camera_pos March (Ã·âŸœ4 +âŸœuâ€¿vâ€¿0 -camera_pos)
	}

	color_mask â† Mask_funcÂ¨Ë field

	# color_mask â†© (â‰ colors) | color_mask
	# img â†© > colors âŠËœ color_mask

	img â†©> {âŒŠc.orange Ã— ((-ğ•©)Ã—20)}Â¨ color_mask

  	c.whiteâ€¿texâ€¿scaleâ€¿0 d.Texture 1â€¿1
  	rayffi.UpdateTexture texâ‹ˆâ¥Šimg
  	# c.whiteâ€¿fontâ€¿30  d.Text 20â€¿20â‹ˆâ€¢Reprâˆ˜win.fps.GetâŠ¸âˆ¾" FPS"

	imgâ€¿wheel
} d._withCanvas_ c.black

Game â† PerFrame â€¢_While_(Â¬win.ShouldClose)_OnStart
Game win._openAs "test"
